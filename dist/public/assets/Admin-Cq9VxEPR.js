import{j as e}from"./ui-DDb1Cthj.js";import{r as E}from"./vendor-CbTYwD9p.js";import{u as K,a as D}from"./query-DJEuKXE5.js";import{k as Oe,u as G,C as F,a as u,B as w,D as Pe,b as Ue,c as Ie,d as Re,j as f,q as S}from"./index-DP8xWL5x.js";import{S as Ne}from"./switch-sf127c2O.js";import{I as U}from"./input-CRHmV_Qe.js";import{L as T}from"./label-DvYd1ndl.js";import{n as ce,a6 as le,a7 as te,a8 as qe,a9 as Me,r as ee,aa as we,ab as pe,ac as ye,a1 as Ke,f as $e,R as fe,l as me,U as re,a5 as W,ad as ze,ae as Te,af as Xe,v as J,C as be,T as Se,e as Be,h as he,ag as Qe,ah as De,ai as ue}from"./icons-DpVlej8W.js";import{R as Y,L as xe,C as ae,X as ne,Y as ie,T as Z,a as oe,b as V,B as He,c as _e,P as Ce,d as Fe,e as Ee}from"./charts-DJyvgdyr.js";import"./router-i_uqa6-9.js";import"./tonconnect-BAw8c48p.js";import"./ton-BfqU8ldO.js";import"./utils-BkWO3WEY.js";const ge=E.forwardRef(({className:d,...x},N)=>e.jsx("textarea",{className:Oe("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",d),ref:N,...x}));ge.displayName="Textarea";function Je(){const{toast:d}=G(),[x,N]=E.useState(!1),[m,h]=E.useState(null),[l,g]=E.useState({seasonId:"",name:"",description:"",startDate:"",endDate:"",bonusMultiplier:"1.0",specialRewards:""}),{data:c=[],isLoading:C}=K({queryKey:["/api/seasons"],queryFn:async()=>{const t=await fetch("/api/seasons");if(!t.ok)throw new Error("Failed to fetch seasons");return t.json()}}),y=D({mutationFn:async t=>{const r=f(),s=await fetch("/api/admin/seasons",{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":r||""},body:JSON.stringify({...t,bonusMultiplier:parseFloat(t.bonusMultiplier)})});if(!s.ok){const a=await s.json();throw new Error(a.error||"Failed to create season")}return s.json()},onSuccess:t=>{S.invalidateQueries({queryKey:["/api/seasons"]}),d({title:"Season Created",description:t.message||"Season created successfully"}),N(!1),L()},onError:t=>{d({title:"Error",description:t.message,variant:"destructive"})}}),k=D({mutationFn:async({seasonId:t,data:r})=>{const s=f(),a=await fetch(`/api/admin/seasons/${t}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":s||""},body:JSON.stringify({...r,bonusMultiplier:parseFloat(r.bonusMultiplier)})});if(!a.ok){const p=await a.json();throw new Error(p.error||"Failed to update season")}return a.json()},onSuccess:t=>{S.invalidateQueries({queryKey:["/api/seasons"]}),d({title:"Season Updated",description:t.message||"Season updated successfully"}),N(!1),h(null),L()},onError:t=>{d({title:"Error",description:t.message,variant:"destructive"})}}),A=D({mutationFn:async({seasonId:t,isActive:r})=>{const s=f(),a=await fetch(`/api/admin/seasons/${t}/toggle`,{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":s||""},body:JSON.stringify({isActive:r})});if(!a.ok){const p=await a.json();throw new Error(p.error||"Failed to toggle season")}return a.json()},onSuccess:t=>{S.invalidateQueries({queryKey:["/api/seasons"]}),S.invalidateQueries({queryKey:["/api/seasons/active"]}),d({title:t.message||"Season Updated",description:`Season has been ${t.season.isActive?"activated":"deactivated"}`})},onError:t=>{d({title:"Error",description:t.message,variant:"destructive"})}}),P=D({mutationFn:async t=>{const r=f(),s=await fetch(`/api/admin/seasons/${t}`,{method:"DELETE",headers:{"X-Telegram-Init-Data":r||""}});if(!s.ok){const a=await s.json();throw new Error(a.error||"Failed to delete season")}return s.json()},onSuccess:t=>{S.invalidateQueries({queryKey:["/api/seasons"]}),d({title:"Season Deleted",description:t.message||"Season deleted successfully"})},onError:t=>{d({title:"Error",description:t.message,variant:"destructive"})}}),L=()=>{g({seasonId:"",name:"",description:"",startDate:"",endDate:"",bonusMultiplier:"1.0",specialRewards:""})},I=t=>{h(t),g({seasonId:t.seasonId,name:t.name,description:t.description,startDate:new Date(t.startDate).toISOString().slice(0,16),endDate:new Date(t.endDate).toISOString().slice(0,16),bonusMultiplier:t.bonusMultiplier.toString(),specialRewards:t.specialRewards||""}),N(!0)},q=()=>{m?k.mutate({seasonId:m.seasonId,data:l}):y.mutate(l)};return e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5 text-purple-500"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Seasons Management"})]}),e.jsxs(u,{onClick:()=>{h(null),L(),N(!0)},size:"sm",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"New Season"]})]}),C?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading seasons..."}):c.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ce,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-30"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No seasons created yet"})]}):e.jsx("div",{className:"space-y-3",children:c.map(t=>{const r=new Date,s=new Date(t.startDate),a=new Date(t.endDate),p=t.isActive&&s<=r&&a>=r;return e.jsxs("div",{className:`p-4 rounded-lg border ${p?"bg-gradient-to-r from-purple-500/10 to-pink-500/10 border-purple-500/30":"bg-background/50 border-border"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-sm",children:t.name}),p&&e.jsx(w,{className:"text-xs bg-purple-500",children:"LIVE"}),t.isActive&&!p&&e.jsx(w,{variant:"outline",className:"text-xs",children:"Active"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.description}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.toLocaleDateString()," - ",a.toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(u,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0",onClick:()=>I(t),children:e.jsx(te,{className:"w-3 h-3"})}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0",onClick:()=>A.mutate({seasonId:t.seasonId,isActive:!t.isActive}),children:t.isActive?e.jsx(qe,{className:"w-3 h-3 text-orange-500"}):e.jsx(Me,{className:"w-3 h-3 text-green-500"})}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0",onClick:()=>{confirm(`Delete season "${t.name}"?`)&&P.mutate(t.seasonId)},children:e.jsx(ee,{className:"w-3 h-3 text-destructive"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs mt-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Bonus Multiplier:"}),e.jsxs("span",{className:"ml-1 font-mono text-matrix-green",children:[t.bonusMultiplier,"x"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Season ID:"}),e.jsx("span",{className:"ml-1 font-mono",children:t.seasonId})]})]})]},t.id)})}),e.jsx(Pe,{open:x,onOpenChange:N,children:e.jsxs(Ue,{className:"max-w-2xl",children:[e.jsx(Ie,{children:e.jsx(Re,{children:m?"Edit Season":"Create New Season"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"seasonId",children:"Season ID"}),e.jsx(U,{id:"seasonId",value:l.seasonId,onChange:t=>g({...l,seasonId:t.target.value}),placeholder:"winter-2024",disabled:!!m})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"name",children:"Season Name"}),e.jsx(U,{id:"name",value:l.name,onChange:t=>g({...l,name:t.target.value}),placeholder:"Winter Wonderland"})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"description",children:"Description"}),e.jsx(ge,{id:"description",value:l.description,onChange:t=>g({...l,description:t.target.value}),placeholder:"A festive winter event with bonus rewards...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"startDate",children:"Start Date"}),e.jsx(U,{id:"startDate",type:"datetime-local",value:l.startDate,onChange:t=>g({...l,startDate:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"endDate",children:"End Date"}),e.jsx(U,{id:"endDate",type:"datetime-local",value:l.endDate,onChange:t=>g({...l,endDate:t.target.value})})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"bonusMultiplier",children:"Bonus Multiplier"}),e.jsx(U,{id:"bonusMultiplier",type:"number",step:"0.1",min:"1",value:l.bonusMultiplier,onChange:t=>g({...l,bonusMultiplier:t.target.value})}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"2.0 = 2x referral bonuses, mining rewards, etc."})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"specialRewards",children:"Special Rewards (JSON)"}),e.jsx(ge,{id:"specialRewards",value:l.specialRewards,onChange:t=>g({...l,specialRewards:t.target.value}),placeholder:'{"equipment": ["asic-s19"], "cs": 10000}',rows:2}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Optional: JSON object for special season rewards"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",className:"flex-1",onClick:()=>{N(!1),h(null),L()},children:"Cancel"}),e.jsx(u,{className:"flex-1",onClick:q,disabled:y.isPending||k.isPending,children:y.isPending||k.isPending?"Saving...":m?"Update Season":"Create Season"})]})]})]})})]})}function We(){const{toast:d}=G(),[x,N]=E.useState(!1),[m,h]=E.useState(null),[l,g]=E.useState({title:"",message:"",targetAudience:"all",scheduledFor:""}),{data:c,isLoading:C}=K({queryKey:["/api/admin/announcements"],queryFn:async()=>{const s=f();if(!s)throw new Error("Not authenticated");const a=await fetch("/api/admin/announcements",{headers:{"X-Telegram-Init-Data":s}});if(!a.ok)throw new Error("Failed to fetch announcements");return a.json()}}),y=D({mutationFn:async s=>{const a=f();if(!a)throw new Error("Not authenticated");const p={title:s.title,message:s.message,targetAudience:s.targetAudience};s.scheduledFor&&(p.scheduledFor=new Date(s.scheduledFor).toISOString());const M=await fetch("/api/admin/announcements",{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":a},body:JSON.stringify(p)});if(!M.ok)throw new Error("Failed to create announcement");return M.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/announcements"]}),g({title:"",message:"",targetAudience:"all",scheduledFor:""}),N(!1),h(null),d({title:"Announcement Created",description:"The announcement has been created successfully"})}}),k=D({mutationFn:async({id:s,data:a})=>{const p=f();if(!p)throw new Error("Not authenticated");const M={...a};a.scheduledFor&&(M.scheduledFor=new Date(a.scheduledFor).toISOString());const _=await fetch(`/api/admin/announcements/${s}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":p},body:JSON.stringify(M)});if(!_.ok)throw new Error("Failed to update announcement");return _.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/announcements"]}),g({title:"",message:"",targetAudience:"all",scheduledFor:""}),h(null),d({title:"Announcement Updated",description:"The announcement has been updated successfully"})}}),A=D({mutationFn:async s=>{const a=f();if(!a)throw new Error("Not authenticated");const p=await fetch(`/api/admin/announcements/${s}`,{method:"DELETE",headers:{"X-Telegram-Init-Data":a}});if(!p.ok)throw new Error("Failed to delete announcement");return p.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/announcements"]}),d({title:"Announcement Deleted",description:"The announcement has been removed"})}}),P=D({mutationFn:async s=>{const a=f();if(!a)throw new Error("Not authenticated");const p=await fetch(`/api/admin/announcements/${s}/send-now`,{method:"POST",headers:{"X-Telegram-Init-Data":a}});if(!p.ok)throw new Error("Failed to send announcement");return p.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/announcements"]}),d({title:"Announcement Sent",description:"The announcement is being sent to users"})}}),L=()=>{if(!l.title||!l.message){d({title:"Validation Error",description:"Title and message are required",variant:"destructive"});return}m?k.mutate({id:m,data:l}):y.mutate(l)},I=s=>{h(s.id),g({title:s.title,message:s.message,targetAudience:s.targetAudience,scheduledFor:s.scheduledFor?new Date(s.scheduledFor).toISOString().slice(0,16):""}),N(!0)},q=()=>{h(null),g({title:"",message:"",targetAudience:"all",scheduledFor:""}),N(!1)},t=(c==null?void 0:c.filter(s=>!s.sentAt))||[],r=(c==null?void 0:c.filter(s=>s.sentAt))||[];return e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5 text-purple-500"}),"Announcements Management"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Broadcast messages to all users or specific audiences"})]}),e.jsxs(u,{onClick:()=>N(!x),size:"sm",variant:x?"outline":"default",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),x?"Cancel":"New Announcement"]})]}),x&&e.jsxs("div",{className:"mb-6 p-4 bg-muted/30 rounded-md space-y-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"title",children:"Title"}),e.jsx(U,{id:"title",value:l.title,onChange:s=>g({...l,title:s.target.value}),placeholder:"Announcement title...",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"message",children:"Message"}),e.jsx("textarea",{id:"message",value:l.message,onChange:s=>g({...l,message:s.target.value}),placeholder:"Announcement message...",className:"mt-1 w-full h-24 px-3 py-2 rounded-md border border-input bg-background"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"targetAudience",children:"Target Audience"}),e.jsxs("select",{id:"targetAudience",value:l.targetAudience,onChange:s=>g({...l,targetAudience:s.target.value}),className:"mt-1 w-full h-10 px-3 rounded-md border border-input bg-background",children:[e.jsx("option",{value:"all",children:"All Users"}),e.jsx("option",{value:"premium",children:"Premium Users"}),e.jsx("option",{value:"new",children:"New Users (< 7 days)"}),e.jsx("option",{value:"active",children:"Active Users"})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"scheduledFor",children:"Schedule For (Optional)"}),e.jsx(U,{id:"scheduledFor",type:"datetime-local",value:l.scheduledFor,onChange:s=>g({...l,scheduledFor:s.target.value}),className:"mt-1"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Leave empty to send immediately"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{onClick:L,disabled:y.isPending||k.isPending,children:[m?"Update":"Create"," Announcement"]}),e.jsx(u,{variant:"outline",onClick:q,children:"Cancel"})]})]}),e.jsxs("div",{className:"space-y-4",children:[t.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground mb-2",children:["Pending (",t.length,")"]}),e.jsx("div",{className:"space-y-2",children:t.map(s=>e.jsx("div",{className:"p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-md",children:e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold",children:s.title}),e.jsx(w,{variant:"outline",className:"text-xs",children:s.targetAudience})]}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:s.message}),s.scheduledFor&&e.jsxs("p",{className:"text-xs text-yellow-600 mt-2",children:["Scheduled: ",new Date(s.scheduledFor).toLocaleString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{size:"sm",variant:"outline",onClick:()=>P.mutate(s.id),disabled:P.isPending,children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>I(s),children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx(u,{size:"sm",variant:"destructive",onClick:()=>A.mutate(s.id),disabled:A.isPending,children:e.jsx(ee,{className:"w-4 h-4"})})]})]})},s.id))})]}),r.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground mb-2",children:["Sent (",r.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:r.map(s=>e.jsx("div",{className:"p-4 bg-muted/30 rounded-md",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold",children:s.title}),e.jsx(w,{variant:"outline",className:"text-xs",children:s.targetAudience}),e.jsx(w,{className:"text-xs bg-matrix-green text-black",children:"Sent"})]}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:s.message}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Sent: ",new Date(s.sentAt).toLocaleString()]})]}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>A.mutate(s.id),disabled:A.isPending,children:e.jsx(ee,{className:"w-4 h-4"})})]})},s.id))})]}),C&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading announcements..."}),!C&&(c==null?void 0:c.length)===0&&e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(we,{className:"w-12 h-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No announcements yet"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Create your first announcement to broadcast to users"})]})]})]})}function Ge(){const{toast:d}=G(),[x,N]=E.useState(!1),[m,h]=E.useState({code:"",description:"",rewardType:"cs",rewardAmount:"",maxUses:"",expiresAt:""}),{data:l,isLoading:g}=K({queryKey:["/api/admin/promo-codes"],queryFn:async()=>{const t=f();if(!t)throw new Error("Not authenticated");const r=await fetch("/api/admin/promo-codes",{headers:{"X-Telegram-Init-Data":t}});if(!r.ok)throw new Error("Failed to fetch promo codes");return r.json()}}),c=D({mutationFn:async t=>{const r=f();if(!r)throw new Error("Not authenticated");const s={code:t.code.toUpperCase(),description:t.description,rewardType:t.rewardType,rewardAmount:t.rewardAmount};t.maxUses&&(s.maxUses=parseInt(t.maxUses)),t.expiresAt&&(s.expiresAt=new Date(t.expiresAt).toISOString());const a=await fetch("/api/admin/promo-codes",{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":r},body:JSON.stringify(s)});if(!a.ok){const p=await a.json();throw new Error(p.error||"Failed to create promo code")}return a.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/promo-codes"]}),h({code:"",description:"",rewardType:"cs",rewardAmount:"",maxUses:"",expiresAt:""}),N(!1),d({title:"Promo Code Created",description:"The promo code has been created successfully"})},onError:t=>{d({title:"Creation Failed",description:t.message,variant:"destructive"})}}),C=D({mutationFn:async({id:t,isActive:r})=>{const s=f();if(!s)throw new Error("Not authenticated");const a=await fetch(`/api/admin/promo-codes/${t}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":s},body:JSON.stringify({isActive:r})});if(!a.ok)throw new Error("Failed to update promo code");return a.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/promo-codes"]}),d({title:"Promo Code Updated",description:"The promo code status has been changed"})}}),y=D({mutationFn:async t=>{const r=f();if(!r)throw new Error("Not authenticated");const s=await fetch(`/api/admin/promo-codes/${t}`,{method:"DELETE",headers:{"X-Telegram-Init-Data":r}});if(!s.ok)throw new Error("Failed to delete promo code");return s.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/promo-codes"]}),d({title:"Promo Code Deleted",description:"The promo code has been removed"})}}),k=()=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let r="";for(let s=0;s<8;s++)r+=t.charAt(Math.floor(Math.random()*t.length));h({...m,code:r})},A=t=>{navigator.clipboard.writeText(t),d({title:"Copied",description:`Code "${t}" copied to clipboard`})},P=()=>{if(!m.code||!m.rewardAmount){d({title:"Validation Error",description:"Code and reward amount are required",variant:"destructive"});return}c.mutate(m)},L=t=>{const r=JSON.parse(t.rewardAmount),s=[];return r.cs>0&&s.push(`${r.cs.toLocaleString()} CS`),r.chst>0&&s.push(`${r.chst.toLocaleString()} CHST`),r.hashrate>0&&s.push(`${r.hashrate.toLocaleString()} HR`),s.join(", ")||"N/A"},I=t=>t.expiresAt?new Date(t.expiresAt)<new Date:!1,q=t=>t.maxUses?t.usedCount>=t.maxUses:!1;return e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ye,{className:"w-5 h-5 text-yellow-500"}),"Promo Codes Management"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Create marketing codes with CS, CHST, or hashrate rewards"})]}),e.jsxs(u,{onClick:()=>N(!x),size:"sm",variant:x?"outline":"default",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),x?"Cancel":"New Promo Code"]})]}),x&&e.jsxs("div",{className:"mb-6 p-4 bg-muted/30 rounded-md space-y-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"code",children:"Code"}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx(U,{id:"code",value:m.code,onChange:t=>h({...m,code:t.target.value.toUpperCase()}),placeholder:"WELCOME2024",className:"flex-1"}),e.jsx(u,{type:"button",variant:"outline",onClick:k,children:"Generate"})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"description",children:"Description"}),e.jsx(U,{id:"description",value:m.description,onChange:t=>h({...m,description:t.target.value}),placeholder:"Welcome bonus for new users...",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"rewardType",children:"Reward Type"}),e.jsxs("select",{id:"rewardType",value:m.rewardType,onChange:t=>h({...m,rewardType:t.target.value}),className:"mt-1 w-full h-10 px-3 rounded-md border border-input bg-background",children:[e.jsx("option",{value:"cs",children:"CryptoScore (CS)"}),e.jsx("option",{value:"chst",children:"CHST Tokens"}),e.jsx("option",{value:"hashrate",children:"Hashrate Boost"}),e.jsx("option",{value:"mixed",children:"Mixed Rewards (JSON)"})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"rewardAmount",children:"Reward Amount"}),m.rewardType==="mixed"?e.jsx("textarea",{id:"rewardAmount",value:m.rewardAmount,onChange:t=>h({...m,rewardAmount:t.target.value}),placeholder:'{"cs": 10000, "chst": 100, "hashrate": 50}',className:"mt-1 w-full h-20 px-3 py-2 rounded-md border border-input bg-background font-mono text-sm"}):e.jsx(U,{id:"rewardAmount",type:"number",value:m.rewardAmount,onChange:t=>h({...m,rewardAmount:t.target.value}),placeholder:"10000",className:"mt-1"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"maxUses",children:"Max Uses (Optional)"}),e.jsx(U,{id:"maxUses",type:"number",value:m.maxUses,onChange:t=>h({...m,maxUses:t.target.value}),placeholder:"Unlimited",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"expiresAt",children:"Expires At (Optional)"}),e.jsx(U,{id:"expiresAt",type:"datetime-local",value:m.expiresAt,onChange:t=>h({...m,expiresAt:t.target.value}),className:"mt-1"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{onClick:P,disabled:c.isPending,children:"Create Promo Code"}),e.jsx(u,{variant:"outline",onClick:()=>{h({code:"",description:"",rewardType:"cs",rewardAmount:"",maxUses:"",expiresAt:""}),N(!1)},children:"Cancel"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:g?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading promo codes..."}):l&&l.length>0?l.map(t=>{const r=I(t),s=q(t),a=!t.isActive||r||s;return e.jsx("div",{className:`p-4 rounded-md ${a?"bg-muted/30 opacity-60":"bg-muted/30"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-bold font-mono text-lg",children:t.code}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>A(t.code),className:"h-6 px-2",children:e.jsx(Ke,{className:"w-3 h-3"})}),t.isActive&&!r&&!s?e.jsx(w,{className:"text-xs bg-matrix-green text-black",children:"Active"}):e.jsx(w,{variant:"secondary",className:"text-xs",children:r?"Expired":s?"Max Uses":"Inactive"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:t.description}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs",children:[e.jsxs(w,{variant:"outline",children:["Reward: ",L(t)]}),e.jsxs(w,{variant:"outline",children:["Used: ",t.usedCount,t.maxUses?` / ${t.maxUses}`:""]}),t.expiresAt&&e.jsxs(w,{variant:"outline",children:["Expires: ",new Date(t.expiresAt).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{size:"sm",variant:t.isActive?"destructive":"default",onClick:()=>C.mutate({id:t.id,isActive:!t.isActive}),disabled:C.isPending||r||s,children:t.isActive?"Disable":"Enable"}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>y.mutate(t.id),disabled:y.isPending,children:e.jsx(ee,{className:"w-4 h-4"})})]})]})},t.id)}):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(ye,{className:"w-12 h-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No promo codes yet"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Create your first promo code for marketing campaigns"})]})})]})}function Ve(){var L,I,q,t;const{toast:d}=G(),[x,N]=E.useState("30"),{data:m,isLoading:h}=K({queryKey:["/api/admin/analytics/overview"],queryFn:async()=>{const r=f();if(!r)throw new Error("Not authenticated");const s=await fetch("/api/admin/analytics/overview",{headers:{"X-Telegram-Init-Data":r}});if(!s.ok)throw new Error("Failed to fetch analytics overview");return s.json()}}),{data:l,isLoading:g}=K({queryKey:["/api/admin/analytics/daily",x],queryFn:async()=>{const r=f();if(!r)throw new Error("Not authenticated");const s=await fetch(`/api/admin/analytics/daily?days=${x}`,{headers:{"X-Telegram-Init-Data":r}});if(!s.ok)throw new Error("Failed to fetch daily analytics");return s.json()}}),{data:c,isLoading:C}=K({queryKey:["/api/admin/analytics/retention"],queryFn:async()=>{const r=f();if(!r)throw new Error("Not authenticated");const s=await fetch("/api/admin/analytics/retention",{headers:{"X-Telegram-Init-Data":r}});if(!s.ok)throw new Error("Failed to fetch retention data");return s.json()}}),y=D({mutationFn:async()=>{const r=f();if(!r)throw new Error("Not authenticated");const s=await fetch("/api/admin/analytics/generate-report",{method:"POST",headers:{"X-Telegram-Init-Data":r}});if(!s.ok)throw new Error("Failed to generate report");return s.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/analytics"]}),d({title:"Report Generated",description:"Analytics report has been generated successfully"})}}),k=D({mutationFn:async()=>{const r=f();if(!r)throw new Error("Not authenticated");const s=await fetch("/api/admin/analytics/update-cohorts",{method:"POST",headers:{"X-Telegram-Init-Data":r}});if(!s.ok)throw new Error("Failed to update cohorts");return s.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/analytics/retention"]}),d({title:"Cohorts Updated",description:"Retention cohorts have been recalculated"})}}),A=(l==null?void 0:l.map(r=>({date:new Date(r.date).toLocaleDateString("en-US",{month:"short",day:"numeric"}),dau:r.dau,newUsers:r.newUsers,revenue:parseFloat(r.tonRevenue||"0")})).reverse())||[],P=(c==null?void 0:c.slice(0,10).map(r=>({date:new Date(r.cohortDate).toLocaleDateString("en-US",{month:"short",day:"numeric"}),d1:parseFloat((r.d1Percent??0).toFixed(1)),d7:parseFloat((r.d7Percent??0).toFixed(1)),d30:parseFloat((r.d30Percent??0).toFixed(1))})).reverse())||[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx($e,{className:"w-5 h-5 text-cyan-500"}),"Analytics Dashboard"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"DAU/MAU tracking, retention metrics, and revenue analysis"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>k.mutate(),disabled:k.isPending,children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Update Cohorts"]}),e.jsxs(u,{size:"sm",onClick:()=>y.mutate(),disabled:y.isPending,children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"Generate Report"]})]})]}),h?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading overview..."}):m&&m.today?e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(re,{className:"w-4 h-4 text-cyan-500"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Today DAU"})]}),e.jsx("p",{className:"text-2xl font-bold font-mono text-cyan-500",children:m.today.dau||0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[m.today.newUsers||0," new users"]})]}),e.jsxs("div",{className:"p-4 bg-purple-500/10 border border-purple-500/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(re,{className:"w-4 h-4 text-purple-500"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"30-Day MAU"})]}),e.jsx("p",{className:"text-2xl font-bold font-mono text-purple-500",children:((L=m.last30Days)==null?void 0:L.mau)||0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Avg DAU: ",((q=(I=m.last30Days)==null?void 0:I.avgDau)==null?void 0:q.toFixed(0))||0]})]}),e.jsxs("div",{className:"p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(W,{className:"w-4 h-4 text-yellow-500"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Today Revenue"})]}),e.jsxs("p",{className:"text-2xl font-bold font-mono text-yellow-500",children:[parseFloat(m.today.tonRevenue||"0").toFixed(2)," TON"]})]}),e.jsxs("div",{className:"p-4 bg-matrix-green/10 border border-matrix-green/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(W,{className:"w-4 h-4 text-matrix-green"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"30-Day Revenue"})]}),e.jsxs("p",{className:"text-2xl font-bold font-mono text-matrix-green",children:[parseFloat(((t=m.last30Days)==null?void 0:t.totalRevenue)||"0").toFixed(2)," TON"]})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No analytics data available"})]}),e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold",children:"Daily Active Users & New Users"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{size:"sm",variant:x==="7"?"default":"outline",onClick:()=>N("7"),children:"7 Days"}),e.jsx(u,{size:"sm",variant:x==="30"?"default":"outline",onClick:()=>N("30"),children:"30 Days"}),e.jsx(u,{size:"sm",variant:x==="90"?"default":"outline",onClick:()=>N("90"),children:"90 Days"})]})]}),g?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading chart..."}):A.length>0?e.jsx(Y,{width:"100%",height:300,children:e.jsxs(xe,{data:A,children:[e.jsx(ae,{strokeDasharray:"3 3",stroke:"#333"}),e.jsx(ne,{dataKey:"date",stroke:"#888",style:{fontSize:"12px"}}),e.jsx(ie,{stroke:"#888",style:{fontSize:"12px"}}),e.jsx(Z,{contentStyle:{backgroundColor:"#1a1a1a",border:"1px solid #333"},labelStyle:{color:"#888"}}),e.jsx(oe,{}),e.jsx(V,{type:"monotone",dataKey:"dau",stroke:"#06b6d4",strokeWidth:2,name:"DAU"}),e.jsx(V,{type:"monotone",dataKey:"newUsers",stroke:"#a855f7",strokeWidth:2,name:"New Users"})]})}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No data available"})]}),e.jsxs(F,{className:"p-6",children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Daily Revenue (TON)"}),g?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading chart..."}):A.length>0?e.jsx(Y,{width:"100%",height:250,children:e.jsxs(He,{data:A,children:[e.jsx(ae,{strokeDasharray:"3 3",stroke:"#333"}),e.jsx(ne,{dataKey:"date",stroke:"#888",style:{fontSize:"12px"}}),e.jsx(ie,{stroke:"#888",style:{fontSize:"12px"}}),e.jsx(Z,{contentStyle:{backgroundColor:"#1a1a1a",border:"1px solid #333"},labelStyle:{color:"#888"}}),e.jsx(_e,{dataKey:"revenue",fill:"#eab308",name:"TON Revenue"})]})}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No data available"})]}),e.jsxs(F,{className:"p-6",children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Retention Cohorts (Last 10 Days)"}),C?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading retention data..."}):P.length>0?e.jsxs(e.Fragment,{children:[e.jsx(Y,{width:"100%",height:300,children:e.jsxs(xe,{data:P,children:[e.jsx(ae,{strokeDasharray:"3 3",stroke:"#333"}),e.jsx(ne,{dataKey:"date",stroke:"#888",style:{fontSize:"12px"}}),e.jsx(ie,{stroke:"#888",style:{fontSize:"12px"},unit:"%"}),e.jsx(Z,{contentStyle:{backgroundColor:"#1a1a1a",border:"1px solid #333"},labelStyle:{color:"#888"},formatter:r=>`${r}%`}),e.jsx(oe,{}),e.jsx(V,{type:"monotone",dataKey:"d1",stroke:"#10b981",strokeWidth:2,name:"D1 Retention"}),e.jsx(V,{type:"monotone",dataKey:"d7",stroke:"#f59e0b",strokeWidth:2,name:"D7 Retention"}),e.jsx(V,{type:"monotone",dataKey:"d30",stroke:"#ef4444",strokeWidth:2,name:"D30 Retention"})]})}),e.jsxs("div",{className:"mt-6 space-y-2 max-h-64 overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-5 gap-2 text-xs font-semibold text-muted-foreground uppercase px-4",children:[e.jsx("div",{children:"Cohort"}),e.jsx("div",{children:"D0"}),e.jsx("div",{children:"D1"}),e.jsx("div",{children:"D7"}),e.jsx("div",{children:"D30"})]}),c==null?void 0:c.slice(0,10).map(r=>e.jsxs("div",{className:"grid grid-cols-5 gap-2 p-4 bg-muted/30 rounded-md text-sm",children:[e.jsx("div",{className:"font-mono",children:new Date(r.cohortDate).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),e.jsx("div",{className:"font-mono",children:r.day0}),e.jsxs("div",{className:"font-mono",children:[r.day1," ",e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",(r.d1Percent??0).toFixed(1),"%)"]})]}),e.jsxs("div",{className:"font-mono",children:[r.day7," ",e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",(r.d7Percent??0).toFixed(1),"%)"]})]}),e.jsxs("div",{className:"font-mono",children:[r.day30," ",e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",(r.d30Percent??0).toFixed(1),"%)"]})]})]},r.cohortDate))]})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No retention data available"})]})]})}function Ye(){const{toast:d}=G(),[x,N]=E.useState(!1),[m,h]=E.useState(null),[l,g]=E.useState({name:"",eventType:"multiplier",eventData:"",startTime:"",endTime:"",isRecurring:!1}),{data:c,isLoading:C}=K({queryKey:["/api/admin/events"],queryFn:async()=>{const n=f();if(!n)throw new Error("Not authenticated");const b=await fetch("/api/admin/events",{headers:{"X-Telegram-Init-Data":n}});if(!b.ok)throw new Error("Failed to fetch events");return b.json()}}),y=D({mutationFn:async n=>{const b=f();if(!b)throw new Error("Not authenticated");const O={name:n.name,eventType:n.eventType,eventData:n.eventData,startTime:new Date(n.startTime).toISOString(),endTime:new Date(n.endTime).toISOString(),isRecurring:n.isRecurring},B=await fetch("/api/admin/events",{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":b},body:JSON.stringify(O)});if(!B.ok){const Q=await B.json();throw new Error(Q.error||"Failed to create event")}return B.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/events"]}),g({name:"",eventType:"multiplier",eventData:"",startTime:"",endTime:"",isRecurring:!1}),N(!1),h(null),d({title:"Event Created",description:"The event has been scheduled successfully"})},onError:n=>{d({title:"Creation Failed",description:n.message,variant:"destructive"})}}),k=D({mutationFn:async({id:n,data:b})=>{const O=f();if(!O)throw new Error("Not authenticated");const B={...b};b.startTime&&(B.startTime=new Date(b.startTime).toISOString()),b.endTime&&(B.endTime=new Date(b.endTime).toISOString());const Q=await fetch(`/api/admin/events/${n}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":O},body:JSON.stringify(B)});if(!Q.ok)throw new Error("Failed to update event");return Q.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/events"]}),g({name:"",eventType:"multiplier",eventData:"",startTime:"",endTime:"",isRecurring:!1}),h(null),d({title:"Event Updated",description:"The event has been updated successfully"})}}),A=D({mutationFn:async n=>{const b=f();if(!b)throw new Error("Not authenticated");const O=await fetch(`/api/admin/events/${n}/activate`,{method:"POST",headers:{"X-Telegram-Init-Data":b}});if(!O.ok)throw new Error("Failed to activate event");return O.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/events"]}),d({title:"Event Activated",description:"The event has been started"})}}),P=D({mutationFn:async n=>{const b=f();if(!b)throw new Error("Not authenticated");const O=await fetch(`/api/admin/events/${n}/end`,{method:"POST",headers:{"X-Telegram-Init-Data":b}});if(!O.ok)throw new Error("Failed to end event");return O.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/events"]}),d({title:"Event Ended",description:"The event has been stopped"})}}),L=D({mutationFn:async n=>{const b=f();if(!b)throw new Error("Not authenticated");const O=await fetch(`/api/admin/events/${n}`,{method:"DELETE",headers:{"X-Telegram-Init-Data":b}});if(!O.ok)throw new Error("Failed to delete event");return O.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/events"]}),d({title:"Event Deleted",description:"The event has been removed"})}}),I=n=>({multiplier:'{"multiplier": 2.0, "description": "Double mining rewards!"}',flash_sale:'{"discount": 50, "itemType": "powerup", "description": "50% off all powerups!"}',community_goal:'{"targetCS": 1000000, "rewardPerUser": 1000, "description": "Mine 1M CS together!"}',tournament:'{"topN": 10, "rewards": [10000, 5000, 2500], "description": "Top miners win big!"}',custom:'{"message": "Special event!", "bonus": "Something cool"}'})[n]||"{}",q=()=>{if(!l.name||!l.startTime||!l.endTime){d({title:"Validation Error",description:"Name, start time, and end time are required",variant:"destructive"});return}try{JSON.parse(l.eventData||"{}")}catch{d({title:"Validation Error",description:"Event data must be valid JSON",variant:"destructive"});return}m?k.mutate({id:m,data:l}):y.mutate(l)},t=n=>{h(n.id),g({name:n.name,eventType:n.eventType,eventData:n.eventData,startTime:new Date(n.startTime).toISOString().slice(0,16),endTime:new Date(n.endTime).toISOString().slice(0,16),isRecurring:n.isRecurring}),N(!0)},r=()=>{h(null),g({name:"",eventType:"multiplier",eventData:"",startTime:"",endTime:"",isRecurring:!1}),N(!1)},s=n=>({multiplier:"Multiplier",flash_sale:"Flash Sale",community_goal:"Community Goal",tournament:"Tournament",custom:"Custom"})[n]||n,a=n=>({multiplier:"bg-purple-500 text-white",flash_sale:"bg-yellow-500 text-black",community_goal:"bg-blue-500 text-white",tournament:"bg-red-500 text-white",custom:"bg-gray-500 text-white"})[n]||"bg-gray-500",p=(c==null?void 0:c.filter(n=>n.isActive))||[],M=(c==null?void 0:c.filter(n=>!n.isActive&&new Date(n.startTime)>new Date))||[],_=(c==null?void 0:c.filter(n=>!n.isActive&&new Date(n.endTime)<new Date))||[];return e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5 text-blue-500"}),"Event Scheduler"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Automated limited-time events with rewards"})]}),e.jsxs(u,{onClick:()=>N(!x),size:"sm",variant:x?"outline":"default",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),x?"Cancel":"New Event"]})]}),x&&e.jsxs("div",{className:"mb-6 p-4 bg-muted/30 rounded-md space-y-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"name",children:"Event Name"}),e.jsx(U,{id:"name",value:l.name,onChange:n=>g({...l,name:n.target.value}),placeholder:"Double Mining Weekend",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"eventType",children:"Event Type"}),e.jsxs("select",{id:"eventType",value:l.eventType,onChange:n=>{const b=n.target.value;g({...l,eventType:b,eventData:I(b)})},className:"mt-1 w-full h-10 px-3 rounded-md border border-input bg-background",children:[e.jsx("option",{value:"multiplier",children:"Multiplier (Mining Boost)"}),e.jsx("option",{value:"flash_sale",children:"Flash Sale (Shop Discount)"}),e.jsx("option",{value:"community_goal",children:"Community Goal"}),e.jsx("option",{value:"tournament",children:"Tournament (Leaderboard)"}),e.jsx("option",{value:"custom",children:"Custom Event"})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"eventData",children:"Event Configuration (JSON)"}),e.jsx("textarea",{id:"eventData",value:l.eventData,onChange:n=>g({...l,eventData:n.target.value}),placeholder:'{"multiplier": 2.0, "description": "Double rewards!"}',className:"mt-1 w-full h-32 px-3 py-2 rounded-md border border-input bg-background font-mono text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"startTime",children:"Start Time"}),e.jsx(U,{id:"startTime",type:"datetime-local",value:l.startTime,onChange:n=>g({...l,startTime:n.target.value}),className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"endTime",children:"End Time"}),e.jsx(U,{id:"endTime",type:"datetime-local",value:l.endTime,onChange:n=>g({...l,endTime:n.target.value}),className:"mt-1"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isRecurring",checked:l.isRecurring,onChange:n=>g({...l,isRecurring:n.target.checked}),className:"rounded"}),e.jsx(T,{htmlFor:"isRecurring",className:"font-normal cursor-pointer",children:"Recurring Event (repeats automatically)"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{onClick:q,disabled:y.isPending||k.isPending,children:[m?"Update":"Create"," Event"]}),e.jsx(u,{variant:"outline",onClick:r,children:"Cancel"})]})]}),e.jsxs("div",{className:"space-y-4",children:[p.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground mb-2",children:["Active Now (",p.length,")"]}),e.jsx("div",{className:"space-y-2",children:p.map(n=>e.jsx("div",{className:"p-4 bg-matrix-green/10 border border-matrix-green/30 rounded-md",children:e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold",children:n.name}),e.jsx(w,{className:`text-xs ${a(n.eventType)}`,children:s(n.eventType)}),e.jsx(w,{className:"text-xs bg-matrix-green text-black",children:"Active"}),n.isRecurring&&e.jsx(w,{variant:"outline",className:"text-xs",children:"Recurring"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["Ends: ",new Date(n.endTime).toLocaleString()]}),e.jsx("pre",{className:"text-xs bg-black/20 p-2 rounded overflow-x-auto",children:JSON.stringify(JSON.parse(n.eventData),null,2)})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(u,{size:"sm",variant:"destructive",onClick:()=>P.mutate(n.id),disabled:P.isPending,children:e.jsx(ze,{className:"w-4 h-4"})})})]})},n.id))})]}),M.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground mb-2",children:["Upcoming (",M.length,")"]}),e.jsx("div",{className:"space-y-2",children:M.map(n=>e.jsx("div",{className:"p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-md",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold",children:n.name}),e.jsx(w,{className:`text-xs ${a(n.eventType)}`,children:s(n.eventType)}),n.isRecurring&&e.jsx(w,{variant:"outline",className:"text-xs",children:"Recurring"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["Starts: ",new Date(n.startTime).toLocaleString(),e.jsx("br",{}),"Ends: ",new Date(n.endTime).toLocaleString()]}),e.jsx("pre",{className:"text-xs bg-black/20 p-2 rounded overflow-x-auto",children:JSON.stringify(JSON.parse(n.eventData),null,2)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{size:"sm",variant:"outline",onClick:()=>A.mutate(n.id),disabled:A.isPending,children:e.jsx(Te,{className:"w-4 h-4"})}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>t(n),children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>L.mutate(n.id),disabled:L.isPending,children:e.jsx(ee,{className:"w-4 h-4"})})]})]})},n.id))})]}),_.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground mb-2",children:["Past Events (",_.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:_.map(n=>e.jsx("div",{className:"p-4 bg-muted/30 rounded-md opacity-60",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold",children:n.name}),e.jsx(w,{className:`text-xs ${a(n.eventType)}`,children:s(n.eventType)}),e.jsx(w,{variant:"secondary",className:"text-xs",children:"Ended"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[new Date(n.startTime).toLocaleDateString()," - ",new Date(n.endTime).toLocaleDateString()]})]}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>L.mutate(n.id),disabled:L.isPending,children:e.jsx(ee,{className:"w-4 h-4"})})]})},n.id))})]}),C&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading events..."}),!C&&(c==null?void 0:c.length)===0&&e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(ce,{className:"w-12 h-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No events scheduled"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Create your first event to engage users"})]})]})]})}function Ze(){const{toast:d}=G(),{data:x,isLoading:N}=K({queryKey:["/api/admin/economy/overview"],queryFn:async()=>{const a=f();if(!a)throw new Error("Not authenticated");const p=await fetch("/api/admin/economy/overview",{headers:{"X-Telegram-Init-Data":a}});if(!p.ok)throw new Error("Failed to fetch economy overview");return p.json()}}),{data:m,isLoading:h}=K({queryKey:["/api/admin/economy/history"],queryFn:async()=>{const a=f();if(!a)throw new Error("Not authenticated");const p=await fetch("/api/admin/economy/history?days=30",{headers:{"X-Telegram-Init-Data":a}});if(!p.ok)throw new Error("Failed to fetch economy history");return p.json()}}),{data:l,isLoading:g}=K({queryKey:["/api/admin/economy/distribution"],queryFn:async()=>{const a=f();if(!a)throw new Error("Not authenticated");const p=await fetch("/api/admin/economy/distribution",{headers:{"X-Telegram-Init-Data":a}});if(!p.ok)throw new Error("Failed to fetch wealth distribution");return p.json()}}),{data:c,isLoading:C}=K({queryKey:["/api/admin/economy/alerts"],queryFn:async()=>{const a=f();if(!a)throw new Error("Not authenticated");const p=await fetch("/api/admin/economy/alerts",{headers:{"X-Telegram-Init-Data":a}});if(!p.ok)throw new Error("Failed to fetch alerts");return p.json()}}),y=D({mutationFn:async()=>{const a=f();if(!a)throw new Error("Not authenticated");const p=await fetch("/api/admin/economy/calculate-metrics",{method:"POST",headers:{"X-Telegram-Init-Data":a}});if(!p.ok)throw new Error("Failed to calculate metrics");return p.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/economy"]}),d({title:"Metrics Calculated",description:"Economy metrics have been recalculated"})}}),k=D({mutationFn:async a=>{const p=f();if(!p)throw new Error("Not authenticated");const M=await fetch(`/api/admin/economy/alerts/${a}/acknowledge`,{method:"POST",headers:{"X-Telegram-Init-Data":p}});if(!M.ok)throw new Error("Failed to acknowledge alert");return M.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/economy/alerts"]}),d({title:"Alert Acknowledged",description:"The alert has been marked as acknowledged"})}}),A=(Array.isArray(m)?m:[]).map(a=>({date:new Date(a.date).toLocaleDateString("en-US",{month:"short",day:"numeric"}),inflation:parseFloat(a.inflationRatePercent)})).reverse(),P=(Array.isArray(m)?m:[]).map(a=>({date:new Date(a.date).toLocaleDateString("en-US",{month:"short",day:"numeric"}),gini:parseFloat(a.giniCoefficient)*100})).reverse(),L=(Array.isArray(l)?l:[]).map(a=>({name:a.percentile,value:parseFloat(a.sharePercent)})),I=["#10b981","#06b6d4","#f59e0b","#ef4444","#8b5cf6"],q=a=>a==="critical"?e.jsx(J,{className:"w-4 h-4 text-red-500"}):a==="warning"?e.jsx(J,{className:"w-4 h-4 text-yellow-500"}):e.jsx(J,{className:"w-4 h-4 text-blue-500"}),t=a=>a==="critical"?"bg-red-500/10 border-red-500/30":a==="warning"?"bg-yellow-500/10 border-yellow-500/30":"bg-blue-500/10 border-blue-500/30",r=a=>a==="healthy"?"bg-matrix-green text-black":a==="warning"?"bg-yellow-500 text-black":"bg-red-500 text-white",s=(c==null?void 0:c.filter(a=>!a.isAcknowledged))||[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5 text-green-500"}),"Economy Dashboard"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"CS inflation monitoring, wealth distribution, and economic health"})]}),e.jsxs(u,{size:"sm",onClick:()=>y.mutate(),disabled:y.isPending,children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Recalculate Metrics"]})]}),N?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading overview..."}):x&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"p-4 bg-matrix-green/10 border border-matrix-green/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(W,{className:"w-4 h-4 text-matrix-green"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Total CS"})]}),e.jsx("p",{className:"text-2xl font-bold font-mono text-matrix-green",children:parseFloat(x.totalCsInCirculation||"0").toLocaleString()})]}),e.jsxs("div",{className:"p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(me,{className:"w-4 h-4 text-yellow-500"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Inflation Rate"})]}),e.jsxs("p",{className:"text-2xl font-bold font-mono text-yellow-500",children:[parseFloat(x.inflationRatePercent||"0").toFixed(2),"%"]})]}),e.jsxs("div",{className:"p-4 bg-purple-500/10 border border-purple-500/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Xe,{className:"w-4 h-4 text-purple-500"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Gini Coefficient"})]}),e.jsx("p",{className:"text-2xl font-bold font-mono text-purple-500",children:parseFloat(x.giniCoefficient||"0").toFixed(3)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"0 = equal, 1 = unequal"})]}),e.jsxs("div",{className:"p-4 bg-red-500/10 border border-red-500/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(J,{className:"w-4 h-4 text-red-500"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Top 10% Own"})]}),e.jsxs("p",{className:"text-2xl font-bold font-mono text-red-500",children:[parseFloat(x.top10PercentOwnership||"0").toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-muted/30 rounded-md",children:[e.jsx(w,{className:`text-sm ${r(x.status||"healthy")}`,children:(x.status||"HEALTHY").toUpperCase()}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.length>0?e.jsxs(e.Fragment,{children:[s.length," unacknowledged alert(s)"]}):e.jsx(e.Fragment,{children:"Economy is stable, no critical issues"})})]})]})]}),s.length>0&&e.jsxs(F,{className:"p-6",children:[e.jsxs("h4",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-red-500"}),"Active Alerts (",s.length,")"]}),e.jsx("div",{className:"space-y-2",children:s.map(a=>e.jsx("div",{className:`p-4 rounded-md border ${t(a.severity)}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[q(a.severity),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(w,{variant:"outline",className:"text-xs",children:a.alertType.replace(/_/g," ")}),e.jsx(w,{variant:"outline",className:"text-xs",children:a.severity})]}),e.jsx("p",{className:"text-sm font-medium mb-1",children:a.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(a.createdAt).toLocaleString()})]})]}),e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>k.mutate(a.id),disabled:k.isPending,children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Acknowledge"]})]})},a.id))})]}),e.jsxs(F,{className:"p-6",children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Inflation Rate (Last 30 Days)"}),h?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading chart..."}):A.length>0?e.jsx(Y,{width:"100%",height:250,children:e.jsxs(xe,{data:A,children:[e.jsx(ae,{strokeDasharray:"3 3",stroke:"#333"}),e.jsx(ne,{dataKey:"date",stroke:"#888",style:{fontSize:"12px"}}),e.jsx(ie,{stroke:"#888",style:{fontSize:"12px"},unit:"%"}),e.jsx(Z,{contentStyle:{backgroundColor:"#1a1a1a",border:"1px solid #333"},labelStyle:{color:"#888"},formatter:a=>`${a}%`}),e.jsx(oe,{}),e.jsx(V,{type:"monotone",dataKey:"inflation",stroke:"#f59e0b",strokeWidth:2,name:"Inflation Rate %"})]})}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No data available"})]}),e.jsxs(F,{className:"p-6",children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Wealth Inequality - Gini Coefficient (Last 30 Days)"}),h?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading chart..."}):P.length>0?e.jsx(Y,{width:"100%",height:250,children:e.jsxs(xe,{data:P,children:[e.jsx(ae,{strokeDasharray:"3 3",stroke:"#333"}),e.jsx(ne,{dataKey:"date",stroke:"#888",style:{fontSize:"12px"}}),e.jsx(ie,{stroke:"#888",style:{fontSize:"12px"},domain:[0,100]}),e.jsx(Z,{contentStyle:{backgroundColor:"#1a1a1a",border:"1px solid #333"},labelStyle:{color:"#888"},formatter:a=>`${a.toFixed(1)}`}),e.jsx(oe,{}),e.jsx(V,{type:"monotone",dataKey:"gini",stroke:"#a855f7",strokeWidth:2,name:"Gini Coefficient (0-100)"})]})}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No data available"})]}),e.jsxs(F,{className:"p-6",children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Wealth Distribution by Percentile"}),g?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading distribution..."}):l&&l.length>0?e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsx(Y,{width:"100%",height:300,children:e.jsxs(Ce,{children:[e.jsx(Fe,{data:L,cx:"50%",cy:"50%",labelLine:!1,label:a=>`${a.name}: ${a.value.toFixed(1)}%`,outerRadius:100,fill:"#8884d8",dataKey:"value",children:L.map((a,p)=>e.jsx(Ee,{fill:I[p%I.length]},`cell-${p}`))}),e.jsx(Z,{formatter:a=>`${a.toFixed(2)}%`})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-2 text-xs font-semibold text-muted-foreground uppercase px-4",children:[e.jsx("div",{children:"Group"}),e.jsx("div",{children:"Users"}),e.jsx("div",{children:"Avg CS"}),e.jsx("div",{children:"Share"})]}),l.map((a,p)=>e.jsxs("div",{className:"grid grid-cols-4 gap-2 p-4 bg-muted/30 rounded-md text-sm",style:{borderLeft:`4px solid ${I[p%I.length]}`},children:[e.jsx("div",{className:"font-semibold",children:a.percentile}),e.jsx("div",{className:"font-mono",children:a.userCount}),e.jsx("div",{className:"font-mono",children:parseFloat(a.avgCs).toLocaleString()}),e.jsxs("div",{className:"font-mono",children:[parseFloat(a.sharePercent).toFixed(1),"%"]})]},a.percentile))]})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No distribution data available"})]}),c&&c.filter(a=>a.isAcknowledged).length>0&&e.jsxs(F,{className:"p-6",children:[e.jsx("h4",{className:"font-semibold mb-4 text-muted-foreground",children:"Alert History (Acknowledged)"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:c.filter(a=>a.isAcknowledged).slice(0,10).map(a=>e.jsxs("div",{className:"p-3 bg-muted/30 rounded-md opacity-60 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(w,{variant:"outline",className:"text-xs",children:a.alertType.replace(/_/g," ")}),e.jsx(w,{variant:"outline",className:"text-xs",children:a.severity}),e.jsx(be,{className:"w-3 h-3 text-green-500"})]}),e.jsx("p",{className:"text-xs",children:a.message}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(a.createdAt).toLocaleString()})]},a.id))})]})]})}function et(){var Q,de;const{toast:d}=G(),[x,N]=E.useState(null),[m,h]=E.useState(!1),[l,g]=E.useState(null),[c,C]=E.useState({targetSegment:"whale",offerType:"promo_code",offerData:"",validFrom:"",validUntil:""}),{data:y,isLoading:k}=K({queryKey:["/api/admin/segments/overview"],queryFn:async()=>{const o=f();if(!o)throw new Error("Not authenticated");const v=await fetch("/api/admin/segments/overview",{headers:{"X-Telegram-Init-Data":o}});if(!v.ok)throw new Error("Failed to fetch segment overview");return v.json()}}),{data:A,isLoading:P}=K({queryKey:["/api/admin/segments",x,"users"],queryFn:async()=>{if(!x)return[];const o=f();if(!o)throw new Error("Not authenticated");const v=await fetch(`/api/admin/segments/${x}/users`,{headers:{"X-Telegram-Init-Data":o}});if(!v.ok)throw new Error("Failed to fetch segment users");return v.json()},enabled:!!x}),{data:L,isLoading:I}=K({queryKey:["/api/admin/segments/offers"],queryFn:async()=>{const o=f();if(!o)throw new Error("Not authenticated");const v=await fetch("/api/admin/segments/offers",{headers:{"X-Telegram-Init-Data":o}});if(!v.ok)throw new Error("Failed to fetch offers");return v.json()}}),q=D({mutationFn:async()=>{const o=f();if(!o)throw new Error("Not authenticated");const v=await fetch("/api/admin/segments/refresh",{method:"POST",headers:{"X-Telegram-Init-Data":o}});if(!v.ok)throw new Error("Failed to refresh segments");return v.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/segments"]}),d({title:"Segments Refreshed",description:"User segments are being recalculated in the background"})}}),t=D({mutationFn:async()=>{const o=f();if(!o)throw new Error("Not authenticated");const v=await fetch("/api/admin/segments/send-reengagement",{method:"POST",headers:{"X-Telegram-Init-Data":o}});if(!v.ok)throw new Error("Failed to send messages");return v.json()},onSuccess:()=>{d({title:"Messages Sent",description:"Re-engagement messages are being sent to at-risk users"})}}),r=D({mutationFn:async()=>{const o=f();if(!o)throw new Error("Not authenticated");const v=await fetch("/api/admin/segments/send-churned",{method:"POST",headers:{"X-Telegram-Init-Data":o}});if(!v.ok)throw new Error("Failed to send messages");return v.json()},onSuccess:()=>{d({title:"Messages Sent",description:"Win-back messages are being sent to churned users"})}}),s=D({mutationFn:async o=>{const v=f();if(!v)throw new Error("Not authenticated");const $={...o,validFrom:new Date(o.validFrom).toISOString(),validUntil:o.validUntil?new Date(o.validUntil).toISOString():null},R=await fetch("/api/admin/segments/offers",{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":v},body:JSON.stringify($)});if(!R.ok){const H=await R.json();throw new Error(H.error||"Failed to create offer")}return R.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/segments/offers"]}),C({targetSegment:"whale",offerType:"promo_code",offerData:"",validFrom:"",validUntil:""}),h(!1),g(null),d({title:"Offer Created",description:"The targeted offer has been created successfully"})},onError:o=>{d({title:"Creation Failed",description:o.message,variant:"destructive"})}}),a=D({mutationFn:async({id:o,data:v})=>{const $=f();if(!$)throw new Error("Not authenticated");const R={...v};v.validFrom&&(R.validFrom=new Date(v.validFrom).toISOString()),v.validUntil&&(R.validUntil=new Date(v.validUntil).toISOString());const H=await fetch(`/api/admin/segments/offers/${o}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":$},body:JSON.stringify(R)});if(!H.ok)throw new Error("Failed to update offer");return H.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/segments/offers"]}),C({targetSegment:"whale",offerType:"promo_code",offerData:"",validFrom:"",validUntil:""}),g(null),d({title:"Offer Updated",description:"The offer has been updated successfully"})}}),p=D({mutationFn:async o=>{const v=f();if(!v)throw new Error("Not authenticated");const $=await fetch(`/api/admin/segments/offers/${o}`,{method:"DELETE",headers:{"X-Telegram-Init-Data":v}});if(!$.ok)throw new Error("Failed to delete offer");return $.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/segments/offers"]}),d({title:"Offer Deleted",description:"The offer has been removed"})}}),M=o=>({promo_code:'{"code": "WHALE50", "description": "50% bonus for whales"}',flash_sale:'{"discount": 30, "description": "30% off premium items"}',bonus_cs:'{"amount": 10000, "description": "10K CS bonus"}',exclusive_equipment:'{"equipmentId": "titan_rig", "description": "Exclusive equipment"}'})[o]||"{}",_=()=>{if(!c.targetSegment||!c.offerData||!c.validFrom){d({title:"Validation Error",description:"Segment, offer data, and start date are required",variant:"destructive"});return}try{JSON.parse(c.offerData)}catch{d({title:"Validation Error",description:"Offer data must be valid JSON",variant:"destructive"});return}l?a.mutate({id:l,data:c}):s.mutate(c)},n=o=>{g(o.id),C({targetSegment:o.targetSegment,offerType:o.offerType,offerData:o.offerData,validFrom:new Date(o.validFrom).toISOString().slice(0,16),validUntil:o.validUntil?new Date(o.validUntil).toISOString().slice(0,16):""}),h(!0)},b=()=>{g(null),C({targetSegment:"whale",offerType:"promo_code",offerData:"",validFrom:"",validUntil:""}),h(!1)},O={whale:{color:"#a855f7",label:"Whale",icon:""},dolphin:{color:"#06b6d4",label:"Dolphin",icon:""},minnow:{color:"#10b981",label:"Minnow",icon:""},new_user:{color:"#f59e0b",label:"New User",icon:""},active:{color:"#22c55e",label:"Active",icon:""},at_risk:{color:"#f97316",label:"At Risk",icon:""},churned:{color:"#ef4444",label:"Churned",icon:""},returning:{color:"#8b5cf6",label:"Returning",icon:""}},B=y?Object.entries(y.segments).map(([o,v])=>{var $,R;return{name:(($=O[o])==null?void 0:$.label)||o,value:v.count,color:((R=O[o])==null?void 0:R.color)||"#888"}}):[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5 text-purple-500"}),"User Segmentation"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"User classification and targeted engagement"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>t.mutate(),disabled:t.isPending,children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Re-engage At-Risk"]}),e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>r.mutate(),disabled:r.isPending,children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Win-Back Churned"]}),e.jsxs(u,{size:"sm",onClick:()=>q.mutate(),disabled:q.isPending,children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Refresh Segments"]})]})]}),k?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading overview..."}):y&&e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Segment Distribution"}),e.jsx(Y,{width:"100%",height:300,children:e.jsxs(Ce,{children:[e.jsx(Fe,{data:B,cx:"50%",cy:"50%",labelLine:!1,label:o=>`${o.name}: ${o.value}`,outerRadius:100,fill:"#8884d8",dataKey:"value",children:B.map((o,v)=>e.jsx(Ee,{fill:o.color},`cell-${v}`))}),e.jsx(Z,{}),e.jsx(oe,{})]})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-4",children:"View Segment Details"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(y.segments).map(([o,v])=>{var $,R;return e.jsxs(u,{variant:x===o?"default":"outline",onClick:()=>N(o),className:"justify-start",children:[e.jsx("span",{className:"mr-2",children:($=O[o])==null?void 0:$.icon}),e.jsxs("div",{className:"text-left flex-1",children:[e.jsx("div",{className:"font-semibold",children:(R=O[o])==null?void 0:R.label}),e.jsxs("div",{className:"text-xs opacity-70",children:[v.count," users (",v.percentage.toFixed(1),"%)"]})]})]},o)})})]})]})]}),x&&e.jsxs(F,{className:"p-6",children:[e.jsxs("h4",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx("span",{children:(Q=O[x])==null?void 0:Q.icon}),(de=O[x])==null?void 0:de.label," Users"]}),P?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading users..."}):A&&A.length>0?e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:A.map(o=>e.jsx("div",{className:"p-4 bg-muted/30 rounded-md",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold",children:o.username||"Anonymous"}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs mt-2",children:[e.jsxs(w,{variant:"outline",children:["LTV: $",parseFloat(o.lifetimeValue).toFixed(2)]}),e.jsxs(w,{variant:"outline",children:["Sessions: ",o.totalSessions]}),e.jsxs(w,{variant:"outline",children:["Last Active: ",o.daysSinceLastActive,"d ago"]}),o.retentionD7&&e.jsx(w,{className:"bg-matrix-green text-black text-xs",children:"D7 Retained"})]})]})})},o.id))}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No users in this segment"})]}),e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Se,{className:"w-5 h-5 text-yellow-500"}),"Targeted Offers"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Create segment-specific promotions and rewards"})]}),e.jsxs(u,{size:"sm",onClick:()=>h(!m),variant:m?"outline":"default",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),m?"Cancel":"New Offer"]})]}),m&&e.jsxs("div",{className:"mb-6 p-4 bg-muted/30 rounded-md space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"targetSegment",children:"Target Segment"}),e.jsxs("select",{id:"targetSegment",value:c.targetSegment,onChange:o=>C({...c,targetSegment:o.target.value}),className:"mt-1 w-full h-10 px-3 rounded-md border border-input bg-background",children:[e.jsx("option",{value:"whale",children:"Whale"}),e.jsx("option",{value:"dolphin",children:"Dolphin"}),e.jsx("option",{value:"minnow",children:"Minnow"}),e.jsx("option",{value:"new_user",children:"New User"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"at_risk",children:"At Risk"}),e.jsx("option",{value:"churned",children:"Churned"}),e.jsx("option",{value:"returning",children:"Returning"})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"offerType",children:"Offer Type"}),e.jsxs("select",{id:"offerType",value:c.offerType,onChange:o=>{const v=o.target.value;C({...c,offerType:v,offerData:M(v)})},className:"mt-1 w-full h-10 px-3 rounded-md border border-input bg-background",children:[e.jsx("option",{value:"promo_code",children:"Promo Code"}),e.jsx("option",{value:"flash_sale",children:"Flash Sale"}),e.jsx("option",{value:"bonus_cs",children:"Bonus CS"}),e.jsx("option",{value:"exclusive_equipment",children:"Exclusive Equipment"})]})]})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"offerData",children:"Offer Configuration (JSON)"}),e.jsx("textarea",{id:"offerData",value:c.offerData,onChange:o=>C({...c,offerData:o.target.value}),placeholder:'{"code": "WHALE50", "description": "Special offer"}',className:"mt-1 w-full h-24 px-3 py-2 rounded-md border border-input bg-background font-mono text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"validFrom",children:"Valid From"}),e.jsx(U,{id:"validFrom",type:"datetime-local",value:c.validFrom,onChange:o=>C({...c,validFrom:o.target.value}),className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"validUntil",children:"Valid Until (Optional)"}),e.jsx(U,{id:"validUntil",type:"datetime-local",value:c.validUntil,onChange:o=>C({...c,validUntil:o.target.value}),className:"mt-1"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{onClick:_,disabled:s.isPending||a.isPending,children:[l?"Update":"Create"," Offer"]}),e.jsx(u,{variant:"outline",onClick:b,children:"Cancel"})]})]}),I?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading offers..."}):L&&L.length>0?e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:L.map(o=>{var R,H;const v=o.validUntil&&new Date(o.validUntil)<new Date,$=o.isActive&&!v;return e.jsx("div",{className:`p-4 rounded-md ${$?"bg-matrix-green/10 border border-matrix-green/30":"bg-muted/30"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(w,{className:"text-xs",style:{backgroundColor:(R=O[o.targetSegment])==null?void 0:R.color},children:(H=O[o.targetSegment])==null?void 0:H.label}),e.jsx(w,{variant:"outline",className:"text-xs",children:o.offerType.replace(/_/g," ")}),$?e.jsx(w,{className:"text-xs bg-matrix-green text-black",children:"Active"}):e.jsx(w,{variant:"secondary",className:"text-xs",children:v?"Expired":"Inactive"})]}),e.jsx("pre",{className:"text-xs bg-black/20 p-2 rounded overflow-x-auto mb-2",children:JSON.stringify(JSON.parse(o.offerData),null,2)}),e.jsxs("div",{className:"flex gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["From: ",new Date(o.validFrom).toLocaleDateString()]}),o.validUntil&&e.jsxs("span",{children:["Until: ",new Date(o.validUntil).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{size:"sm",variant:"outline",onClick:()=>n(o),children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>p.mutate(o.id),disabled:p.isPending,children:e.jsx(ee,{className:"w-4 h-4"})})]})]})},o.id)})}):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(Se,{className:"w-12 h-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No targeted offers yet"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Create segment-specific offers to engage users"})]})]})]})}function gt(){const{toast:d}=G(),[x,N]=E.useState(!1),[m,h]=E.useState(""),[l,g]=E.useState(!1),[c,C]=E.useState(null),[y,k]=E.useState(""),[A,P]=E.useState(""),[L,I]=E.useState(null),[q,t]=E.useState(null),[r,s]=E.useState(""),[a,p]=E.useState(""),{data:M,isLoading:_}=K({queryKey:["/api/admin/settings"],queryFn:async()=>{const i=f();if(!i)throw new Error("Not authenticated");const j=await fetch("/api/admin/settings",{headers:{"X-Telegram-Init-Data":i}});if(!j.ok)throw new Error("Failed to fetch settings");return j.json()}}),{data:n,isLoading:b}=K({queryKey:["/api/admin/users"],queryFn:async()=>{const i=f();if(!i)throw new Error("Not authenticated");const j=await fetch("/api/admin/users",{headers:{"X-Telegram-Init-Data":i}});if(!j.ok)throw new Error("Failed to fetch users");return j.json()}}),{data:O,isLoading:B}=K({queryKey:["/api/equipment-types"]}),{data:Q,isLoading:de}=K({queryKey:["/api/admin/feature-flags"],queryFn:async()=>{const i=f();if(!i)throw new Error("Not authenticated");const j=await fetch("/api/admin/feature-flags",{headers:{"X-Telegram-Init-Data":i}});if(!j.ok)throw new Error("Failed to fetch feature flags");return j.json()}});E.useEffect(()=>{const i=M==null?void 0:M.find(j=>j.key==="mining_paused");N((i==null?void 0:i.value)==="true")},[M]);const o=D({mutationFn:async i=>{const j=f();if(!j)throw new Error("Not authenticated");const X=await fetch(i?"/api/admin/mining/pause":"/api/admin/mining/resume",{method:"POST",headers:{"X-Telegram-Init-Data":j}});if(!X.ok)throw new Error("Failed to update mining status");return X.json()},onSuccess:(i,j)=>{N(j),S.invalidateQueries({queryKey:["/api/admin/settings"]}),d({title:j?"Mining Paused":"Mining Resumed",description:j?"Block mining has been paused":"Block mining has resumed"})}}),v=D({mutationFn:async({userId:i,isAdmin:j})=>{const z=f();if(!z)throw new Error("Not authenticated");const X=await fetch(`/api/admin/users/${i}/admin`,{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":z},body:JSON.stringify({isAdmin:j})});if(!X.ok)throw new Error("Failed to update admin status");return X.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/users"]}),d({title:"Admin Status Updated",description:"User permissions have been changed"})}}),$=D({mutationFn:async({userId:i,csBalance:j,chstBalance:z})=>{const X=f();if(!X)throw new Error("Not authenticated");const se=await fetch(`/api/admin/users/${i}/balance`,{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":X},body:JSON.stringify({csBalance:j,chstBalance:z})});if(!se.ok)throw new Error("Failed to update balance");return se.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/users"]}),t(null),s(""),p(""),d({title:"Balance Updated",description:"User balance has been updated successfully"})}}),R=D({mutationFn:async()=>{const i=f();if(!i)throw new Error("Not authenticated");const j=await fetch("/api/admin/reset-all-users",{method:"DELETE",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":i}});if(!j.ok)throw new Error("Failed to reset game data");return j.json()},onSuccess:i=>{S.invalidateQueries({queryKey:["/api/admin/users"]}),h(""),g(!1),d({title:"Game Reset Successful",description:`Reset ${i.users_reset} users and deleted ${Object.values(i.records_deleted||{}).reduce((j,z)=>j+(z||0),0)} records`})},onError:i=>{d({title:"Reset Failed",description:i.message||"Failed to reset game data",variant:"destructive"})}}),H=D({mutationFn:async()=>{const i=f();if(!i)throw new Error("Not authenticated");const j=await fetch("/api/admin/recalculate-hashrates",{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":i}});if(!j.ok)throw new Error("Failed to recalculate hashrates");return j.json()},onSuccess:i=>{S.invalidateQueries({queryKey:["/api/admin/users"]}),d({title:"Hashrates Recalculated",description:`Updated ${i.usersUpdated} out of ${i.totalUsers} users with corrected hashrates`})},onError:i=>{d({title:"Recalculation Failed",description:i.message||"Failed to recalculate hashrates",variant:"destructive"})}}),je=D({mutationFn:async({equipmentId:i,basePrice:j,currency:z})=>{const X=f();if(!X)throw new Error("Not authenticated");const se=await fetch(`/api/admin/equipment/${i}/update`,{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":X},body:JSON.stringify({basePrice:j,currency:z})});if(!se.ok)throw new Error("Failed to update equipment");return se.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/equipment-types"]}),C(null),k(""),P(""),d({title:"Equipment Updated",description:"Price and currency have been updated successfully"})},onError:i=>{d({title:"Update Failed",description:i.message||"Failed to update equipment",variant:"destructive"})}}),ve=D({mutationFn:async({featureKey:i,isEnabled:j})=>{const z=f();if(!z)throw new Error("Not authenticated");const X=await fetch(`/api/admin/feature-flags/${i}`,{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":z},body:JSON.stringify({isEnabled:j})});if(!X.ok)throw new Error("Failed to update feature flag");return X.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["/api/admin/feature-flags"]}),S.invalidateQueries({queryKey:["/api/feature-flags"]}),d({title:"Feature Updated",description:"Feature visibility has been changed"})},onError:i=>{d({title:"Update Failed",description:i.message||"Failed to update feature flag",variant:"destructive"})}}),ke=(n==null?void 0:n.length)||0,Ae=(n==null?void 0:n.reduce((i,j)=>i+j.csBalance,0))||0,Le=(n==null?void 0:n.reduce((i,j)=>i+j.totalHashrate,0))||0;return e.jsx("div",{className:"min-h-screen bg-background p-2 md:p-4",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-md bg-destructive/20 flex items-center justify-center",children:e.jsx(Be,{className:"w-6 h-6 text-destructive"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-2xl lg:text-3xl font-bold",children:"Admin Panel"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase tracking-wider",children:"Game Management Console"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4",children:[e.jsxs(F,{className:"p-3 md:p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(re,{className:"w-4 h-4 text-cyber-blue"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Total Users"})]}),e.jsx("p",{className:"text-xl md:text-2xl font-bold font-mono","data-testid":"text-total-users",children:b?"...":ke})]}),e.jsxs(F,{className:"p-3 md:p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(W,{className:"w-4 h-4 text-matrix-green"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Total CS"})]}),e.jsx("p",{className:"text-xl md:text-2xl font-bold font-mono text-matrix-green","data-testid":"text-total-cs",children:b?"...":Ae.toLocaleString()})]}),e.jsxs(F,{className:"p-3 md:p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(he,{className:"w-4 h-4 text-neon-orange"}),e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:"Total HR"})]}),e.jsx("p",{className:"text-xl md:text-2xl font-bold font-mono","data-testid":"text-total-hashrate",children:b?"...":Le.toLocaleString()})]})]}),e.jsxs(F,{className:"p-4 md:p-6",children:[e.jsxs("h3",{className:"text-base md:text-lg font-semibold mb-3 md:mb-4 flex items-center gap-2",children:[e.jsx(he,{className:"w-4 md:w-5 h-4 md:h-5"}),"Mining Control"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 p-3 md:p-4 bg-muted/30 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[x?e.jsx(Qe,{className:"w-5 h-5 text-destructive"}):e.jsx(Te,{className:"w-5 h-5 text-matrix-green"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Block Mining"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:x?"Currently paused":"Currently active"})]})]}),e.jsx(u,{onClick:()=>o.mutate(!x),variant:x?"default":"destructive","data-testid":x?"button-resume-mining":"button-pause-mining",children:x?"Resume Mining":"Pause Mining"})]})]}),e.jsxs(F,{className:"p-4 md:p-6",children:[e.jsxs("h3",{className:"text-base md:text-lg font-semibold mb-3 md:mb-4 flex items-center gap-2",children:[e.jsx(De,{className:"w-4 md:w-5 h-4 md:h-5 text-purple-500"}),"Feature Flags - Enable/Disable Pages"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground mb-4",children:"Control which features and pages are visible to users in navigation"}),e.jsx("div",{className:"space-y-2 max-h-[60vh] md:max-h-96 overflow-y-auto",children:de?e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Loading feature flags..."}):Q&&Q.length>0?Q.map(i=>e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 p-3 md:p-4 bg-muted/30 rounded-md",children:[e.jsxs("div",{className:"flex-1 w-full sm:w-auto",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold text-sm md:text-base",children:i.featureName}),i.isEnabled?e.jsx(w,{className:"text-xs bg-matrix-green text-black",children:"Enabled"}):e.jsx(w,{variant:"secondary",className:"text-xs",children:"Disabled"})]}),i.description&&e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:i.description}),e.jsxs("p",{className:"text-xs text-muted-foreground/70",children:["Key: ",i.featureKey]})]}),e.jsx(Ne,{checked:i.isEnabled,onCheckedChange:j=>ve.mutate({featureKey:i.featureKey,isEnabled:j}),disabled:ve.isPending,className:"flex-shrink-0"})]},i.id)):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(De,{className:"w-12 h-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"No feature flags configured"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Feature flags will be seeded automatically on first deploy"})]})})]}),e.jsxs(F,{className:"p-4 md:p-6",children:[e.jsxs("h3",{className:"text-base md:text-lg font-semibold mb-3 md:mb-4 flex items-center gap-2",children:[e.jsx(W,{className:"w-4 md:w-5 h-4 md:h-5"}),"Equipment Price Management"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground mb-4",children:"Modify equipment prices and currency types (CS, CHST, or TON)"}),e.jsx("div",{className:"space-y-2 max-h-[60vh] md:max-h-96 overflow-y-auto",children:B?e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Loading equipment..."}):O==null?void 0:O.map(i=>e.jsx("div",{className:"flex items-center justify-between p-4 bg-muted/30 rounded-md",children:c===i.id?e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-sm mb-2",children:i.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(T,{htmlFor:`price-${i.id}`,className:"text-xs",children:"Price"}),e.jsx(U,{id:`price-${i.id}`,type:"number",value:y,onChange:j=>k(j.target.value),placeholder:i.basePrice.toString(),className:"mt-1"})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(T,{htmlFor:`currency-${i.id}`,className:"text-xs",children:"Currency"}),e.jsxs("select",{id:`currency-${i.id}`,value:A,onChange:j=>P(j.target.value),className:"mt-1 w-full h-10 px-3 rounded-md border border-input bg-background",children:[e.jsx("option",{value:"CS",children:"CS"}),e.jsx("option",{value:"CHST",children:"CHST"}),e.jsx("option",{value:"TON",children:"TON"})]})]})]})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{size:"sm",onClick:()=>{const j=y?parseFloat(y):void 0,z=A||void 0;(j||z)&&je.mutate({equipmentId:i.id,basePrice:j,currency:z})},disabled:je.isPending,children:"Save"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>{C(null),k(""),P("")},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-sm",children:i.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[i.category,"  ",i.tier]})]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-mono text-sm font-semibold",children:[i.basePrice.toLocaleString()," ",i.currency]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[i.baseHashrate.toLocaleString()," H/s"]})]}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>{C(i.id),k(i.basePrice.toString()),P(i.currency)},children:e.jsx(te,{className:"w-4 h-4"})})]})]})},i.id))})]}),e.jsxs(F,{className:"p-4 md:p-6",children:[e.jsxs("h3",{className:"text-base md:text-lg font-semibold mb-3 md:mb-4 flex items-center gap-2",children:[e.jsx(re,{className:"w-4 md:w-5 h-4 md:h-5"}),"User Management"]}),e.jsx("div",{className:"space-y-2 max-h-[60vh] md:max-h-96 overflow-y-auto",children:b?e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Loading users..."}):n==null?void 0:n.map(i=>e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 p-3 md:p-4 bg-muted/30 rounded-md","data-testid":`user-row-${i.id}`,children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-sm md:text-base",children:i.username}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["CS: ",i.csBalance.toLocaleString()," | HR: ",i.totalHashrate.toFixed(0)]})]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-3",children:[i.isAdmin&&e.jsx(w,{variant:"destructive",className:"text-xs",children:"Admin"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>I(i.id),className:"text-xs",children:"View Payments"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>{t(i.id),s(i.csBalance.toString()),p(i.chstBalance.toString())},className:"text-xs",children:"Edit Balance"}),e.jsx(Ne,{checked:i.isAdmin,onCheckedChange:j=>v.mutate({userId:i.id,isAdmin:j}),"data-testid":`switch-admin-${i.id}`})]})]},i.id))})]}),L&&e.jsx(tt,{userId:L,onClose:()=>I(null)}),q&&e.jsx(st,{userId:q,user:n==null?void 0:n.find(i=>i.id===q),editCs:r,editChst:a,setEditCs:s,setEditChst:p,updateBalanceMutation:$,onClose:()=>{t(null),s(""),p("")}}),e.jsxs(F,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(he,{className:"w-5 h-5"}),"Game Content Overview"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 bg-muted/30 rounded-md",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(w,{variant:"outline",className:"text-xs",children:"Daily Challenges"})}),e.jsx("p",{className:"text-2xl font-bold",children:"5"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Active challenges"})]}),e.jsxs("div",{className:"p-4 bg-muted/30 rounded-md",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(w,{variant:"outline",className:"text-xs",children:"Achievements"})}),e.jsx("p",{className:"text-2xl font-bold",children:"8"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total achievements"})]}),e.jsxs("div",{className:"p-4 bg-muted/30 rounded-md",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(w,{variant:"outline",className:"text-xs",children:"Cosmetics"})}),e.jsx("p",{className:"text-2xl font-bold",children:"13"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Available items"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-4",children:" Game content is automatically seeded from server/seedGameContent.ts. To modify challenges, achievements, or cosmetic items, update that file and redeploy."})]}),e.jsx(Je,{}),e.jsx(We,{}),e.jsx(Ge,{}),e.jsx(Ve,{}),e.jsx(Ye,{}),e.jsx(Ze,{}),e.jsx(et,{}),e.jsxs(F,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(me,{className:"w-5 h-5 text-cyan-500"}),"Recalculate Hashrates"]}),e.jsx("div",{className:"p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-md",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(J,{className:"w-5 h-5 text-cyan-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Fix Hashrate Inconsistencies"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"This will recalculate all users' total hashrate based on their actual equipment. Use this to fix data inconsistencies (e.g., user shows hashrate but has no rigs). This is a safe operation that only updates hashrate values."}),e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>H.mutate(),disabled:H.isPending,className:"border-cyan-500 text-cyan-500 hover:bg-cyan-500/10",children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),H.isPending?"Recalculating...":"Recalculate All Hashrates"]})]})]})})]}),e.jsxs(F,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5 text-destructive"}),"Game Reset"]}),l?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-destructive/10 border border-destructive/30 rounded-md",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(J,{className:"w-5 h-5 text-destructive mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-destructive font-semibold mb-2",children:" DANGER ZONE "}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"This will permanently delete ALL game data for ALL users:"}),e.jsxs("ul",{className:"text-sm text-muted-foreground list-disc list-inside space-y-1 mb-3",children:[e.jsx("li",{children:"All equipment and upgrades"}),e.jsx("li",{children:"All CS and CHST balances"}),e.jsx("li",{children:"All hashrate and mining progress"}),e.jsx("li",{children:"All block rewards and referrals"})]}),e.jsx("p",{className:"text-sm text-destructive font-semibold",children:"This action CANNOT be undone!"})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"reset-confirm",className:"text-sm font-medium",children:'Type "RESET ALL DATA" to confirm:'}),e.jsx(U,{id:"reset-confirm",value:m,onChange:i=>h(i.target.value),placeholder:"RESET ALL DATA",className:"mt-1"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(u,{variant:"destructive",disabled:m!=="RESET ALL DATA"||R.isPending,onClick:()=>{R.mutate()},children:R.isPending?"Resetting...":e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Reset All Users"]})}),e.jsx(u,{variant:"outline",onClick:()=>{g(!1),h("")},children:"Cancel"})]})]})]}):e.jsx("div",{className:"p-4 bg-destructive/10 border border-destructive/30 rounded-md",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(J,{className:"w-5 h-5 text-destructive mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-destructive font-semibold mb-2",children:"Reset Game Data"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"This will permanently delete all user equipment, balances, hashrate, and progress. This action cannot be undone."}),e.jsxs(u,{variant:"destructive",size:"sm",onClick:()=>g(!0),children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Show Reset Options"]})]})]})})]})]})})}function tt({userId:d,onClose:x}){const{data:N,isLoading:m}=K({queryKey:[`/api/admin/users/${d}/payment-history`],queryFn:async()=>{const h=f();if(!h)throw new Error("Not authenticated");const l=await fetch(`/api/admin/users/${d}/payment-history`,{headers:{"X-Telegram-Init-Data":h}});if(!l.ok)throw new Error("Failed to fetch payment history");return l.json()}});return e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5 text-yellow-500"}),"Payment Logs - User ",d.slice(0,8),"..."]}),e.jsx(u,{size:"sm",variant:"outline",onClick:x,children:"Close"})]}),m?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading payment history..."}):N&&N.payments.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-md",children:[e.jsx("p",{className:"text-xs text-muted-foreground uppercase mb-1",children:"Total TON Spent"}),e.jsxs("p",{className:"text-2xl font-bold font-mono text-yellow-500",children:[N.totalTonSpent," TON"]})]}),e.jsxs("div",{className:"p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-md",children:[e.jsx("p",{className:"text-xs text-muted-foreground uppercase mb-1",children:"Total Purchases"}),e.jsx("p",{className:"text-2xl font-bold font-mono text-cyan-500",children:N.totalPayments})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:N.payments.map(h=>e.jsxs("div",{className:"p-4 bg-muted/30 rounded-md border border-border",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(w,{variant:h.verified?"default":"secondary",className:"text-xs",children:h.type}),h.verified&&e.jsx(w,{variant:"outline",className:"text-xs border-green-500 text-green-500",children:"Verified"})]}),e.jsx("p",{className:"font-semibold text-sm capitalize",children:h.itemName.replace(/_/g," ")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(h.purchasedAt).toLocaleString()})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-mono font-bold text-yellow-500",children:[h.tonAmount," TON"]})})]}),e.jsxs("div",{className:"mt-2 pt-2 border-t border-border/50",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Transaction Hash:"}),e.jsx("p",{className:"text-xs font-mono break-all bg-black/20 p-2 rounded",children:h.transactionHash})]}),e.jsxs("div",{className:"mt-2 pt-2 border-t border-border/50",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Rewards:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[h.rewards.cs>0&&e.jsxs(w,{variant:"outline",className:"text-xs",children:[h.rewards.cs.toLocaleString()," CS"]}),h.rewards.chst>0&&e.jsxs(w,{variant:"outline",className:"text-xs",children:[h.rewards.chst.toLocaleString()," CHST"]}),h.rewards.items&&h.rewards.items.length>0&&h.rewards.items.map((l,g)=>e.jsx(w,{variant:"outline",className:"text-xs capitalize",children:l.replace(/_/g," ")},g))]})]})]},h.id))})]}):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(W,{className:"w-12 h-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No payment history found for this user."}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"TON purchases will appear here once made."})]})]})}function st({userId:d,user:x,editCs:N,editChst:m,setEditCs:h,setEditChst:l,updateBalanceMutation:g,onClose:c}){const C=()=>{const y=N?parseFloat(N):void 0,k=m?parseFloat(m):void 0;(y!==void 0||k!==void 0)&&g.mutate({userId:d,csBalance:y,chstBalance:k})};return e.jsxs(F,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 text-matrix-green"}),"Edit Balance - ",(x==null?void 0:x.username)||d.slice(0,8)+"..."]}),e.jsx(u,{size:"sm",variant:"outline",onClick:c,children:"Close"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-muted/30 rounded-md",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Current Balances:"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"CS"}),e.jsx("p",{className:"text-lg font-mono font-bold text-matrix-green",children:(x==null?void 0:x.csBalance.toLocaleString())||"0"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"CHST"}),e.jsx("p",{className:"text-lg font-mono font-bold text-cyber-blue",children:(x==null?void 0:x.chstBalance.toLocaleString())||"0"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(T,{htmlFor:"edit-cs",className:"text-sm font-medium",children:"New CS Balance"}),e.jsx(U,{id:"edit-cs",type:"number",value:N,onChange:y=>h(y.target.value),placeholder:"Enter CS amount",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(T,{htmlFor:"edit-chst",className:"text-sm font-medium",children:"New CHST Balance"}),e.jsx(U,{id:"edit-chst",type:"number",value:m,onChange:y=>l(y.target.value),placeholder:"Enter CHST amount",className:"mt-1"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(u,{onClick:C,disabled:g.isPending||!N&&!m,className:"bg-matrix-green hover:bg-matrix-green/90 text-black",children:g.isPending?"Updating...":"Update Balance"}),e.jsx(u,{variant:"outline",onClick:c,children:"Cancel"})]}),e.jsx("div",{className:"p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-md",children:e.jsx("p",{className:"text-xs text-yellow-600 dark:text-yellow-400",children:" This will set the user's balance to the exact amounts entered. Use this for testing or support purposes."})})]})]})}export{gt as default};
